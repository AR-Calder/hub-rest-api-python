#!/usr/bin/env python

import argparse
import copy
from datetime import datetime
import json
import logging
import sys
import timestring

from blackduck.HubRestApi import HubInstance, object_id

#
# Example usage:
#	To get all the vulnerabilities (first time) and save the last run date/time,
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -s > vulnerabilities.json
#
#	Having saved the last run date/time, use it to view any newly published vulnerabilities that have come out since the last run,
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -n `cat .last_run` > vulnerabilities_since.json
#
#	Having saved the last run date/time, use it to view any newly published vulnerabilities that have come out since the last run
#	and update the last run date/time,
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -s -n `cat .last_run` > vulnerabilities_since.json
#
#	Use --newer_than (aka -n) to specify your own date (or date/time),
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -n "2017" > vulnerabilities_since_2017.json
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -n "July 1 2018" > vulnerabilities_since_July_1_2018.json
#		python examples/get_bom_component_vulnerability_info.py struts2-showcase 2.6-SNAPSHOT -n "July 1 2018 5:30 pm" > vulnerabilities_since_July_1_2018_1730.json


parser = argparse.ArgumentParser("Retreive BOM component vulnerability information for the given project and version")
parser.add_argument("project_name")
parser.add_argument("version")
parser.add_argument("-u", "--include_updated_vulns", 
    action='store_true', 
    help="If set, will also retrieve vulnerabilities whose update date/time is later than the newer_than date/time")
parser.add_argument("-n", "--newer_than", 
	default=None, 
	type=str,
	help="Set this option to see all vulnerabilities published since the given date/time.")
parser.add_argument("-s", "--save_dt", 
	action='store_true', 
	help="If set, the date/time will be saved to a file named '.last_run' in the current directory which can be used later with the -n option to see vulnerabilities published since the last run.")
args = parser.parse_args()

if args.newer_than:
	newer_than = timestring.Date(args.newer_than).date
else:
	newer_than = None

if args.save_dt:
	with open(".last_run", "w") as f:
		f.write(datetime.now().isoformat())

logging.basicConfig(format='%(asctime)s:%(levelname)s:%(message)s', stream=sys.stderr, level=logging.DEBUG)
logging.getLogger("requests").setLevel(logging.WARNING)
logging.getLogger("urllib3").setLevel(logging.WARNING)

hub = HubInstance()

project = hub.get_project_by_name(args.project_name)

version = hub.get_version_by_name(project, args.version)
version_id = object_id(version)

vulnerable_components_url = hub.get_link(version, "vulnerable-components") + "?limit=9999"
custom_headers = {'Accept':'application/vnd.blackducksoftware.bill-of-materials-6+json'}
response = hub.execute_get(vulnerable_components_url, custom_headers=custom_headers)
import pdb; pdb.set_trace()
vulnerable_bom_components = response.json().get('items', [])

#
# Rebuild vulnerable bom components using the vulnerability info
# From the internal API used by the GUI
# The internal API respsonse includes 'relatedVulnerabilities'
# for the case where a BDSA record overlaps with a CVE
#

# First, generate a list of unique BOM components (with vulnerabilities)
# See https://stackoverflow.com/questions/11092511/python-list-of-unique-dictionaries
unique_components = list({vc['componentVersion']:vc for vc in vulnerable_bom_components}.values())

# Now retrieve the vulnerabilities for each component to re-build the list
vulnerable_bom_components = []
for component in unique_components:
    component_url = component['componentVersion']
    component_version_id = component_url.split("/")[-1]
    private_vuln_url = hub.get_apibase() + "/v1/releases/{}/RL/{}/vulnerabilities?limit=100".format(
        version_id, component_version_id)
    response = hub.execute_get(private_vuln_url)
    component_vulns = response.json().get('items', [])
    for vuln in component_vulns:
        component_copy = copy.deepcopy(component)
        component_copy['vulnerabilityWithRemediation'] = vuln
        vulnerable_bom_components.append(component_copy)

if vulnerable_bom_components:
    vulnerable_bom_components = sorted(
        vulnerable_bom_components, 
        key = lambda k: k['vulnerabilityWithRemediation']['publishedDate'])
    if newer_than:
        if args.include_updated_vulns:
            vulnerable_bom_components = [v for v in vulnerable_bom_components 
                if timestring.Date(v['vulnerabilityWithRemediation']['publishedDate']) > newer_than 
                or timestring.Date(v['vulnerabilityWithRemediation']['lastModified']) > newer_than ]
        else:
        	vulnerable_bom_components = [v for v in vulnerable_bom_components 
    			if timestring.Date(v['vulnerabilityWithRemediation']['publishDate']) > newer_than ]
else:
	logging.debug("Did not find any vulnerable BOM components in project {}, version {}".format(args.project_name, args.version))

print(json.dumps(vulnerable_bom_components))

